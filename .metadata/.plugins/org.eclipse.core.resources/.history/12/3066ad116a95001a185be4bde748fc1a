<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:os="http://www.mulesoft.org/schema/mule/os" xmlns:validation="http://www.mulesoft.org/schema/mule/validation"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd">
	<flow name="testPost" doc:id="d121269d-ee7b-426f-a4a4-f219c1641486" >
		<http:listener doc:name="GET /posttest" doc:id="26c80a90-d210-42df-92d0-9f1eeb077e31" config-ref="HTTP_Listener_config" path="/posttest" allowedMethods="GET" doc:description="This flow simply creates a record and submits it as an object to the POST implementation"/>
		<set-payload value='#[{
	"objecttypename" : "ship",
	"objectproperties" :
		{ "line" : "Nimitz", "year" : "1999" },
	"objectdata" : "dataencodedinline"
}]' doc:name="Set Payload" doc:id="59e74388-1a4d-4553-83af-5ae2331e90d2" />
		<flow-ref doc:name="postObject" doc:id="6401a891-29a5-4249-8719-a549222a8a1c" name="postObject" target="newObjectKey"/>
		<set-payload doc:name="Set Payload" doc:id="bd3f0b74-abbb-4f77-bb2d-291e5ffa3d2c" mimeType="application/json" value='#[output application/json --- { "newly-added-key" : (vars.newObjectKey default "unassignedKey")}]'/>
		<logger level="INFO" doc:name="Logger" doc:id="27518863-8bcb-470e-af32-27a66d0dcc6d" message='#["Posted object: " ++ (vars.newObjectKey default "unassignedKey")]'/>
	</flow>
	<flow name="reportKeys" doc:id="9aca6374-7617-494c-83cf-7ded90ea4e4a" >
		<http:listener doc:name="Get /okeys" doc:id="a5c79d80-3708-4684-b9e0-4894ba15d7ff" config-ref="HTTP_Listener_config" path="/okeys" allowedMethods="GET"/>
		<os:retrieve-all-keys doc:name="Retrieve all keys" doc:id="259eabcb-97db-4a46-9e2e-f47ce2a6eb65" />
		<logger level="INFO" doc:name="Logger" doc:id="aabf7e3e-7e5e-4174-863c-f70a9fe44c12" message="#[payload]"/>
	</flow>
	<flow name="postObject" doc:id="07012b87-45bc-428f-9e63-5e95cbaf14d0" >
		<try doc:name="Try" doc:id="b028b7f4-ce96-4c02-acff-c22bc84c5476" >
			<flow-ref doc:name="createValidKey" doc:id="52db9f99-fb3f-4fbc-8f0c-45103272ec51" name="createValidKey" />
			<error-handler >
				<on-error-continue enableNotifications="true" logException="false" doc:name="On Error Continue" doc:id="ddddea8a-3af6-47c6-be12-14273d395a5c" >
					<flow-ref doc:name="Flow Reference" doc:id="fe4ba295-2b17-4c88-9664-59b57af81718" name="createValidKey"/>
				</on-error-continue>
			</error-handler>
		</try>
		<os:store doc:name="Store" doc:id="07cf11b8-ab7c-443d-8cd3-951dd0c80769" key="#[vars.candidateKey]" doc:description="Stalled here ... the needed value is localized to the Until Successful block"/>
		<set-payload value="#[vars.candidateKey]" doc:name="Set Payload" doc:id="06b37062-577a-4f4e-b5e7-121a13c106cd" />
	</flow>
	<sub-flow name="createValidKey" doc:id="d0e32f87-7095-48b9-a8a3-1436ef5e8e46" >
		<set-variable value='#[(payload.objecttypename default "generic") ++ (now() as String {format: "-yyMMddhhmm-"}) ++ randomInt(10000)]' doc:name="candidateKey" doc:id="e30c18d7-41be-4298-bf41-d86c2248adaa" variableName="candidateKey" />
		<os:retrieve doc:name="candidateKey" doc:id="27397c63-d14e-4a72-83b4-567e4565c3a6" doc:description="Check Object store to ensure that key is not already in use" key="#[vars.candidateKey]" target="availableKey">
			<os:default-value><![CDATA[#[true]]]></os:default-value>
		</os:retrieve>
		<validation:is-true doc:name="Is key available" doc:id="26d1a51c-c833-43c4-b549-a14fe28188c8" expression="#[vars.availableKey]" />
	</sub-flow>
	<flow name="keyStatus" doc:id="78ba79f9-1777-4bac-8c04-19875d86e8b6" >
		<validation:matches-regex doc:id="9b26b83a-1a28-470c-a8c7-a913e3e3022b" value="#[payload]" regex="#[/^[A-Za-z0-9:\-\.]*$/]" message="bad input!" doc:name="Safe Key Content" />
	</flow>
</mule>
